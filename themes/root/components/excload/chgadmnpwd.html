<form>
  <div id="logform" style="margin-top:1em; margin-bottom:1em;">
    <template>
      <div class="boxframe loginform" style="margin:1em;">
        <div>Please set password for</div>
        <div>
          <b></b>
          <script>
            thisNode.writeProperty(thisElement);
          </script>
        </div>
        <div class="form-group" style="position:relative;">
          <label class="form-label" for="new_password"></label>
          <script>
            const myNode=thisParams.textdatanode.getNextChild("newpwd").getRelationship("domelementsdata").getChild();
            myNode.writeProperty(thisElement);
            //adding the edition pencil
            if (webuser.isWebAdmin()) {
              Node.dom.visibleOnMouseOver({element: thisElement.parentElement.querySelector('[data-id=butedit]'), parent: thisElement.parentElement});
              myNode.appendView(thisElement.parentElement.querySelector('[data-id=butedit]'), "butedit", {editElement: thisElement});
            }
          </script>
          <input type="password" class="form-control" placeholder="" name="new_password" data-name="">
          <script>
            thisNode.writeProperty(thisElement, null, "data-name");
            thisParams.textdatanode.getNextChild("newpwd").getRelationship("domelementsdata").getChild().writeProperty(thisElement, null, "placeholder");
          </script>
        </div>
        <div class="form-group" style="position:relative;">
          <div data-id="butedit" class="btmiddleright"></div>
          <label class="form-label" for="repeat_password">Repeat password</label>
          <script>
            const myNode=thisParams.textdatanode.getNextChild("repeatpwd").getRelationship("domelementsdata").getChild();
            myNode.writeProperty(thisElement);
            //adding the edition pencil
            if (webuser.isWebAdmin()) {
              Node.dom.visibleOnMouseOver({element: thisElement.parentElement.querySelector('[data-id=butedit]'), parent: thisElement.parentElement});
              myNode.appendView(thisElement.parentElement.querySelector('[data-id=butedit]'), "butedit", {editElement: thisElement});
            }
          </script>
          <input type="password" class="form-control" placeholder="" name="repeat_password" data-name="">
          <script>
            thisNode.writeProperty(thisElement, null, "data-name");
            thisParams.textdatanode.getNextChild("repeatpwd").getRelationship("domelementsdata").getChild().writeProperty(thisElement, null, "placeholder");
          </script>
        </div>
        <div>
          <button type="button" class="btn" data-id="but"></button>
          <script>
            const myNode=thisParams.textdatanode.getNextChild("btsmt").getRelationship("domelementsdata").getChild();
            myNode.writeProperty(thisElement);
            thisElement.addEventListener("click", (event)=>{
              event.preventDefault();
              const myCheck=Node.dom.checkValidData({props: {new_password: thisElement.form.querySelector('input[name=new_password][data-name=' + thisNode.props.username + ']').value}});
              if (myCheck!==true) {
                //Errors in characters
                (new AlertMessage(thisElement.form.elements.pwdCharError.value, 3000)).showAlert();
                thisElement.form.querySelector('input[name=' + myCheck.errorKey + '][data-name=' + thisNode.props.username + ']').focus();
                return;
              }
              if (thisElement.form.querySelector('input[name=new_password][data-name=' + thisNode.props.username + ']').value!=thisElement.form.querySelector('input[name=repeat_password][data-name=' + thisNode.props.username + ']').value) {
                (new AlertMessage(thisElement.form.elements.pwdDoubleError.value, 3000)).showAlert();
                thisElement.form.querySelector('input[name=repeat_password][data-name=' + thisNode.props.username + ']').focus();
                return;
              }
              webuser.updatePwd(thisNode.props.username, thisElement.form.querySelector('input[name=new_password][data-name=' + thisNode.props.username + ']').value)
              .then(res=>(new AlertMessage(thisElement.form.elements.pwdOk.value, 3000)).showAlert())
              .catch(error=>{
                (new AlertMessage(thisElement.form.elements.pwdNotOk.value, 3000)).showAlert();
                console.error(error);
              });
            });
          </script>
        </div>
      </div>
    </template>
    <div style="display:flex; flex-direction: row; margin:1em; flex-wrap: wrap;"></div>
    <script>
    const textdatanode=domelementsroot.getNextChild("labels").getNextChild("middle").getNextChild("dashboard").getNextChild("changepwd");
    //We load administration users
    const usersTypesMother=await (new NodeFemale('TABLE_USERSTYPES')).loadRequest("get all my children");
    let listTypes=[];
    for (const child of usersTypesMother.children) {
      await child.loadRequest("get my relationships");
      child.getRelationship().addChild(new User());
      if (child.getRelationship().getChild().isAdmin()) {
        child.getRelationship().removeChild(child.getRelationship().getChild());
        listTypes.push(child);
      }
    }
    for (const userType of listTypes){
      (await userType.getRelationship().loadRequest("get my children")).getChild().appendView(thisElement, thisElement.previousElementSibling, {textdatanode: textdatanode});
    }
    </script>
    <div style="position:relative;">
      <input type="hidden" name="pwdCharError" disabled>
      <script>
        var myNode=domelementsroot.getNextChild("labels").getNextChild("middle").getNextChild("logform").getNextChild("pwdCharError").getRelationship("domelementsdata").getChild();
        myNode.writeProperty(thisElement, null, "value");
      </script>
    </div>
    <div style="position:relative;">
      <input type="hidden" name="pwdOk" disabled>
      <script>
        const pwdform=domelementsroot.getNextChild("labels").getNextChild("middle").getNextChild("dashboard").getNextChild("changepwd");
        pwdform.getNextChild("pwdChangeOk").getRelationship("domelementsdata").getChild().writeProperty(thisElement);
      </script>
    </div>
    <div style="position:relative;">
      <input type="hidden" name="pwdNotOk" disabled>
      <script>
        const pwdform=domelementsroot.getNextChild("labels").getNextChild("middle").getNextChild("dashboard").getNextChild("changepwd");
        pwdform.getNextChild("pwdChangeError").getRelationship("domelementsdata").getChild().writeProperty(thisElement);
      </script>
    </div>
    <div style="position:relative;">
      <input type="hidden" name="pwdDoubleError" disabled>
      <script>
        const pwdform=domelementsroot.getNextChild("labels").getNextChild("middle").getNextChild("dashboard").getNextChild("changepwd");
        pwdform.getNextChild("pwdDoubleError").getRelationship("domelementsdata").getChild().writeProperty(thisElement);
      </script>
    </div>
    <div class="dashbuttons">
      <div style="position:relative;">
        <button type="button" class="btn" data-id="but" style="padding:1em;">Finish</button>
        <script>
        thisElement.addEventListener("click", (event)=>{
          webuser.logout()
          .then(()=>location.reload());
        });
        </script>
      </div>
    </div>
  </div>
</form>